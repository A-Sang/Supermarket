{% extends 'common/goodspublic.html' %}
{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>超市</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="icon" type="image/png" href="/theme/default/images/favicon.png">
    <link href="css/amazeui.min.css" rel="stylesheet" type="text/css"/>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    {% block title %}购物车{% endblock %}
    {% block head %}
        <script src="{% static 'js/jquery-1.10.2.min.js' %}"></script>
    {% endblock %}

</head>
<body>
{% block header %}
    <header data-am-widget="header" class="am-header am-header-default sq-head ">
        <div class="am-header-left am-header-nav">
            <a href="javascript:history.back()" class="">
                <i class="am-icon-chevron-left"></i>
            </a>
        </div>
        <h1 class="am-header-title">
            <a href="" class="">购物车</a>
        </h1>
    </header>
{% endblock %}

{% block content %}
    <div style="height: 49px;"></div>
    <ul class="shopcart-list">
        {% for sku,count in goods.items %}
            <li>
                <label class="am-checkbox am-warning">
                    <input id="goods_sku" type="checkbox" value="" data-am-ucheck>
                </label>
                <a href="{% url 'goods:商品详情' sku.pk %}"><img src="{{ MEDIA_URL }}{{ sku.LOGO }}" class="shop-pic"/></a>
                <div class="shop-list-mid">
                    <div class="tit"><a href="{% url 'goods:商品详情' sku.pk %}">
                        {{ sku.spu.spu_name }}{{ sku.sku_name }}</a></div>
                    <i class="shop-list-price">￥</i><b id="price" class="shop-list-price">{{ sku.price }}</b>
                </div>
                <div class="list-cart1">
                    <div class="d-stock">
                        <a class="decrease">-</a>
                        <input sku_id="{{ sku.pk }}" readonly="" class="text_box" name="count" type="text"
                               value="{{ count }}">
                        <a class="increase">+</a>
                    </div>
                </div>
            </li>
        {% empty %}
            <!--购物车空的状态-->
            <div class="login-logo">
                <img src="{% static 'images/care.png' %}">
                <p>亲、您的购物车还是空空的哦，快去装满它!</p>
                <a href="{% url 'goods:商品分类' '' '' %}" class="goshopping">前去逛逛</a>
            </div>
        {% endfor %}
        <div style="height: 10px; background: #eee;"></div>
    </ul>

    <div class="shop-fix">

        <label class="am-checkbox am-warning">
            <input id="check_all" type="checkbox" value="" data-am-ucheck>
        </label>
        <a class="del">全选</a>
        <a href="tureorder.html" class="js-btn">去结算</a>
        <div class="js-text">
            <P>合计：<b id="total_price">￥0.00</b></P>
            <p class="js-car">免费配送</p>
        </div>
    </div>
{% endblock %}


{% block foot_js %}
    <script>
        //购物数量加减
        $(function () {
            $('.increase').click(function () {
                var self = $(this);
                var current_num = parseInt(self.siblings('input').val());
                //发送ajax请求
                var sku_id = self.siblings('input').attr('sku_id');
                var data = {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'count': 1,
                    'sku_id': sku_id
                };
                $.ajax({
                    type: 'post',
                    url: "{% url 'shopcart:增加' %}",
                    data: data,
                    dataType: 'json',
                    success: function (data) {
                        console.debug(data)
                        if (data.code == 0) {
                            //验证成功
                            current_num += 1;
                            self.siblings('input').val(current_num);
                            $('#price').text('￥' + data.data.total_price);
                        }
                        else if (data.code == 4) {
                            //未登录
                            if (confirm('未登录，知否马上登录')) {
                                location.href = "{% url 'user:登录' %}"
                            }
                        } else {
                            alert(data.errmsg)
                        }
                    }
                });
            });

            $('.decrease').click(function () {
                var self = $(this);
                var current_num = parseInt(self.siblings('input').val());
                //发送ajax请求
                var sku_id = self.siblings('input').attr('sku_id');
                var data = {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'count': -1,
                    'sku_id': sku_id
                };
                $.ajax({
                    type: 'post',
                    url: "{% url 'shopcart:减少' %}",
                    data: data,
                    dataType: 'json',
                    success: function (data) {
                        if (data.code == 0) {
                            if (current_num > 0) {
                                current_num -= 1;
                                self.siblings('input').val(current_num);
                                $('#price').text('￥' + data.data.total_price);
                                if (current_num <= 0) {
                                    $.ajax({
                                        type: 'post',
                                        url: "{% url 'shopcart:删除' %}",
                                        data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'sku_id': sku_id},
                                        dataType: 'json',
                                        success: function (data) {
                                            if (data.code == 0) {
                                                location.href = "{% url 'shopcart:购物车' %}"
                                            } else {
                                                alert(data.errmsg)
                                            }
                                        }
                                    })
                                }
                            }
                        } else {
                            alert(data.errmsg)
                        }
                    }
                });

            });
            $('#check_all').on('change', function () {
                var status = $(this).prop('checked');
                $("input[type='checkbox']").prop("checked", status);
                totalPrice()
            });

            $("input[type='checkbox']").each(function (i) {
                if ($(this).prop('checked', true)) {
                    $('#check_all').prop('checked', true)
                }
                else {
                    $('#check_all').prop('checked', false)
                }
            });

            //计算只有没选中的商品总价格
            function totalPrice() {
                var checkboxes = $("input[type='checkbox']").find('checked');
                var total_price = 0;
                $(checkboxes).each(function (i) {
                    //e为被选中的复选框
                    var li = $(this).parents("li");
                    //console.debug(li)
                    var price = li.find('#price').text();
                    var count = li.find('.text_box').val();
                    total_price += price * count;
                    $('#total_price').text('￥')
                })

            }

            totalPrice()
        });
    </script>
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/amazeui.min.js' %}"></script>
{% endblock %}

